{% extends 'base/vistas_base.html' %}
{% load static  %}
{% block title %}Ventas{% endblock %}
{% block css %}
  <link rel="stylesheet" href="{% static "vendor/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" %}">
  <link rel="stylesheet" href="{% static "vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css" %}">
{% endblock %}
{% block content %}
  <div class="content animate-panel">
      <div class="row">
          <div class="col-lg-12">
              <div class="hpanel hgreen">
                <div class="panel-heading mayusculas">
                    Ventas
                </div>
                <div class="panel-body">
                  
                  <div class='text-center'>
                      <h1>{{title}}</h1>
                      <div class="container">
                        <div class="row">
                          <div class="col">
                            <p>{{ content }}</p>
                          </div>
                        </div>
                      </div>
                  </div>

                 <div class="col-sm-6 col-12">
                    <!--<form method="POST">
                      {% csrf_token %}
                      {{ form.as_p}}
                      <button type="submit" class="btn btn-default">Submit</button>
                    </form>-->

                    <form action="generacion/" method="POST">
                      <div class="form-group">
                        <h3>Selecciona las opciones, para generar el reporte</h3>
                        {% csrf_token %}
                        <div class="input-daterange input-group" id="datepicker">
                            <span class="input-group-addon"> De </span>
                            <input type="text" class="input-sm form-control" name="start" />
                            <span class="input-group-addon"> a </span>
                            <input type="text" class="input-sm form-control" name="end" />
                        </div>
                        {{form.as_p}}
                        <button type="submit" class="btn btn-success">Ir</button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
          </div>
      </div>
  </div>
{% endblock %}

{% block javascripts %}
    <script src="{% static "vendor/datatables/media/js/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "vendor/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js" %}"></script>
    <script src="{% static "vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js" %}" charset="UTF-8"></script>
    <script src="{% static "vendor/bootstrap-datepicker-master/dist/locales/bootstrap-datepicker.es.min.js" %}" charset="UTF-8"></script>

    <script>

    $(function () {
          //Calendario.
          $('#datepicker').datepicker({
              language: 'es'
          });

          $("#datepicker").on("changeDate", function(event) {
              $("#my_hidden_input").val(
                      $("#datepicker").datepicker('getFormattedDate')
              )
          });

          {% block jquery %}

              //Se ocultan los select para que paso a paso se vayan seleccionando las opciones que el usuario quiera
              $("label[for=id_departamento], #id_departamento").hide();
              $("label[for=id_plan], #id_plan").hide();

              //Se agrega una opcion adicional al primer select (InstitucionesFinancieras) con la opcion de Todas
              $("#id_institucion").append('<option value="0">Todos</option>');

              //Cuando el choice field de institucion cambia
              $("#id_institucion").change(function(){
                  var inst = $("#id_institucion").val()
                  console.log(inst)
                  var request = $.ajax({
                    method: "POST",
                    url: "",
                    data:{
                      institucion: inst,
                      csrfmiddlewaretoken: "{{ csrf_token }}",
                    }
                  })
                  request.done(function(depto){
                    $("#id_departamento").empty()
                    if(depto.length != 0){
                      if(depto.deptos == "Todos"){
                        console.log("Deptos: " + depto.deptos)
                        $("label[for=id_departamento], #id_departamento").hide();
                        $("label[for=id_plan], #id_plan").hide();
                        $("#id_departamento").empty()
                        $("#id_plan").empty()
                      }
                      else{
                        if(inst != ''){
                          console.log("Deptos: " + depto.deptos)
                          $("label[for=id_departamento], #id_departamento").show();
                          $.each(depto.deptos, function(index, value){
                              $('#id_departamento').append('<option value="'+ value[1]+'">'+value[0]+'</option>')
                          });
                        }
                        else{
                          console.log("Ocultando el select de Departamentos y planes")
                          $("label[for=id_departamento], #id_departamento").hide();
                          $("label[for=id_plan], #id_plan").hide();
                        }
                      }
                    }
                  })
                  request.fail(function(jqXHR, textStatus){
                    if(jqXHR.status == 404){
                      alert("Page not found")
                    }
                    else{
                      alert("There was an error with your request. Please try again")
                    }
                  })
              });

              //cuando el choice field de departamento cambia
              $("#id_departamento").change(function(){
                var depto = $("#id_departamento").val()
                var request = $.ajax({
                  method: "POST",
                  url: "servicios/",
                  data: {
                    departamento: depto,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                  }
                });
                request.done(function(plan){
                  $("#id_plan").empty()
                  if(plan.length !=0 && plan.planes != "----------,Todos" ){
                    if(depto == 0){
                      console.log("Planes: " + plan.planes)
                      $("label[for=id_plan], #id_plan").hide();
                    }
                    else{
                      if(depto != ''){
                        console.log("Planes: " + plan.planes)
                        $("label[for=id_plan], #id_plan").show();
                        $.each(plan.planes, function(index, value){
                            $('#id_plan').append('<option value="'+ value[1]+'">'+value[0]+'</option>')
                        });
                      }
                    }
                  }
                  else{
                    console.log("Ocultando el select de planes")
                    $("label[for=id_plan], #id_plan").hide();
                  }
                })
                request.fail(function(){
                  if(jqXHR.status == 404){
                    alert("Page not found")
                  }
                  else{
                    alert("There was an error with your request. Please try again")
                  }
                })
              });

          {% endblock jquery%}
    });

  </script>
{% endblock %}