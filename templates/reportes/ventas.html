<!doctype html>
  <html lang="en">
    <head>
      <title>Hello, world!</title>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    </head>
    <body>

      <div class='text-center'>
          <h1>{{title}}</h1>
          <div class="container">
            <div class="row">
              <div class="col">
                <p>{{ content }}</p>
              </div>
            </div>
          </div>
      </div>

     <div class="col-sm-6 col-12">
        <!--<form method="POST">
          {% csrf_token %}
          {{ form.as_p}}
          <button type="submit" class="btn btn-default">Submit</button>
        </form>-->

        <form action="generacion/" method="POST">
          {% csrf_token %}
          <h3>Selecciona las opciones, para generar el reporte</h3>

          {{form.as_p}}

          <button type="submit" class="btn btn-default">Submit</button>
        </form>
      </div>



      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-1.11.3.min.js"> </script>
      <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"> </script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

      <script>
        $(document).ready(function(event){
          {% block jquery %}

              //Se ocultan los select para que paso a paso se vayan seleccionando las opciones que el usuario quiera
              $("label[for=id_departamento], #id_departamento").hide();
              $("label[for=id_plan], #id_plan").hide();

              //Se agrega una opcion adicional al primer select (InstitucionesFinancieras) con la opcion de Todas
              $("#id_institucion").append('<option value="0">Todos</option>');

              //Cuando el choice field de institucion cambia
              $("#id_institucion").change(function(){
                  var inst = $("#id_institucion").val()
                  console.log(inst)
                  var request = $.ajax({
                    method: "POST",
                    url: "",
                    data:{
                      institucion: inst,
                      csrfmiddlewaretoken: "{{ csrf_token }}",
                    }
                  })
                  request.done(function(depto){
                    $("#id_departamento").empty()
                    if(depto.length != 0){
                      if(depto.deptos == "Todos"){
                        console.log("Deptos: " + depto.deptos)
                        $("label[for=id_departamento], #id_departamento").hide();
                        $("label[for=id_plan], #id_plan").hide();
                        $("#id_departamento").empty()
                        $("#id_plan").empty()
                      }
                      else{
                        if(inst != ''){
                          console.log("Deptos: " + depto.deptos)
                          $("label[for=id_departamento], #id_departamento").show();
                          $.each(depto.deptos, function(index, value){
                              $('#id_departamento').append('<option value="'+ value[1]+'">'+value[0]+'</option>')
                          });
                        }
                        else{
                          console.log("Ocultando el select de Departamentos y planes")
                          $("label[for=id_departamento], #id_departamento").hide();
                          $("label[for=id_plan], #id_plan").hide();
                        }
                      }
                    }
                  })
                  request.fail(function(jqXHR, textStatus){
                    if(jqXHR.status == 404){
                      alert("Page not found")
                    }
                    else{
                      alert("There was an error with your request. Please try again")
                    }
                  })
              });

              //cuando el choice field de departamento cambia
              $("#id_departamento").change(function(){
                var depto = $("#id_departamento").val()
                var request = $.ajax({
                  method: "POST",
                  url: "servicios/",
                  data: {
                    departamento: depto,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                  }
                });
                request.done(function(plan){
                  $("#id_plan").empty()
                  if(plan.length !=0 && plan.planes != "----------,Todos" ){
                    if(depto == 0){
                      console.log("Planes: " + plan.planes)
                      $("label[for=id_plan], #id_plan").hide();
                    }
                    else{
                      if(depto != ''){
                        console.log("Planes: " + plan.planes)
                        $("label[for=id_plan], #id_plan").show();
                        $.each(plan.planes, function(index, value){
                            $('#id_plan').append('<option value="'+ value[1]+'">'+value[0]+'</option>')
                        });
                      }
                    }
                  }
                  else{
                    console.log("Ocultando el select de planes")
                    $("label[for=id_plan], #id_plan").hide();
                  }
                })
                request.fail(function(){
                  if(jqXHR.status == 404){
                    alert("Page not found")
                  }
                  else{
                    alert("There was an error with your request. Please try again")
                  }
                })
              });

          {% endblock jquery%}
        })
      </script>

    </body>
  </html>
